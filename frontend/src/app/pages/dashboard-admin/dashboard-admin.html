<!-- src/app/pages/dashboard-admin/dashboard-admin.component.html -->

<div class="admin-dashboard">

    <!-- HEADER -->
    <header class="admin-header">
        <div class="header-content">
            <div class="header-left">
                <h1>ğŸ›¡ï¸ Admin Dashboard</h1>
                <p class="admin-welcome" *ngIf="currentAdmin">
                    Welcome, <strong>{{ currentAdmin.full_name || currentAdmin.username }}</strong>
                </p>
            </div>
            <button (click)="logout()" class="btn-logout">
                Logout
            </button>
        </div>
    </header>

    <!-- NAVIGATION TABS -->
    <nav class="admin-nav">
        <button class="nav-tab" [class.active]="activeView === 'overview'" (click)="switchView('overview')">
            ğŸ“Š Overview
        </button>
        <button class="nav-tab" [class.active]="activeView === 'users'" (click)="switchView('users')">
            ğŸ‘¥ Users
        </button>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="admin-content">

        <!-- MENSAJES DE ERROR Y Ã‰XITO -->
        <div class="alert alert-danger" *ngIf="errorMessage">
            <strong>Error:</strong> {{ errorMessage }}
        </div>

        <div class="alert alert-success" *ngIf="successMessage">
            <strong>Success:</strong> {{ successMessage }}
        </div>

        <!-- LOADING SPINNER -->
        <div class="loading-overlay" *ngIf="isLoading">
            <div class="spinner-large"></div>
            <p>Loading...</p>
        </div>

        <!-- OVERVIEW VIEW -->
        <div class="view-container" *ngIf="activeView === 'overview'">
            <h2>System Overview</h2>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-info">
                        <h3>{{ stats.totalUsers }}</h3>
                        <p>Total Users</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">ğŸ›¡ï¸</div>
                    <div class="stat-info">
                        <h3>{{ stats.adminUsers }}</h3>
                        <p>Administrators</p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¤</div>
                    <div class="stat-info">
                        <h3>{{ stats.standardUsers }}</h3>
                        <p>Standard Users</p>
                    </div>
                </div>
            </div>

            <!-- RECENT USERS -->
            <div class="recent-section">
                <h3>Recent Users</h3>
                <div class="users-list-compact">
                    <div class="user-item-compact" *ngFor="let user of allUsers.slice(0, 5)" (click)="selectUser(user)">
                        <div class="user-avatar">
                            {{ (user.username || user.email || '?').charAt(0).toUpperCase() }}
                        </div>
                        <div class="user-details">
                            <p class="user-name">{{ user.full_name || user.username }}</p>
                            <p class="user-email">{{ user.email }}</p>
                        </div>
                        <span class="user-badge" [class.admin]="user.role === 'admin'">
                            {{ user.role === 'admin' ? 'ğŸ›¡ï¸ Admin' : 'ğŸ‘¤ User' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- USERS VIEW -->
        <div class="view-container" *ngIf="activeView === 'users'">
            <div class="view-header">
                <h2>All Users ({{ allUsers.length }})</h2>
                <button (click)="loadAllUsers()" class="btn-refresh">
                    ğŸ”„ Refresh
                </button>
            </div>

            <!-- USERS TABLE -->
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let user of allUsers">
                            <td>
                                <div class="user-cell">
                                    <div class="user-avatar-small">
                                        {{ (user.username || user.email || '?').charAt(0).toUpperCase() }}
                                    </div>
                                    <span>{{ user.full_name || user.username }}</span>
                                </div>
                            </td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.username }}</td>
                            <td>
                                <span class="role-badge" [class.admin]="user.role === 'admin'">
                                    {{ user.role === 'admin' ? 'Admin' : 'Standard User' }}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button (click)="selectUser(user)" class="btn-action btn-edit" title="Edit user">
                                        âœï¸ Edit
                                    </button>
                                    <button (click)="deleteUser(user)" class="btn-action btn-delete"
                                        [disabled]="user.id === currentAdmin?.id" title="Delete user">
                                        ğŸ—‘ï¸ Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- EMPTY STATE -->
                <div class="empty-state" *ngIf="allUsers.length === 0 && !isLoading">
                    <p>No users found</p>
                </div>
            </div>
        </div>

        <!-- EDIT USER VIEW -->
        <div class="view-container" *ngIf="activeView === 'edit' && selectedUser">
            <div class="view-header">
                <h2>Edit User</h2>
                <button (click)="cancelEdit()" class="btn-cancel">
                    â† Back to Users
                </button>
            </div>

            <div class="edit-container">
                <!-- USER INFO CARD -->
                <div class="user-info-card">
                    <div class="user-avatar-large">
                        {{ (selectedUser.username || selectedUser.email || '?').charAt(0).toUpperCase() }}
                    </div>
                    <h3>{{ selectedUser.username }}</h3>
                    <p class="user-id">ID: {{ selectedUser.id }}</p>
                    <span class="role-badge" [class.admin]="selectedUser.role === 'admin'">
                        {{ selectedUser.role === 'admin' ? 'ğŸ›¡ï¸ Administrator' : 'ğŸ‘¤ Standard User' }}
                    </span>
                </div>

                <!-- EDIT FORM -->
                <div class="edit-form-card">
                    <h3>Edit Information</h3>

                    <form [formGroup]="editForm" (ngSubmit)="saveUserChanges()">

                        <!-- FULL NAME -->
                        <div class="form-group">
                            <label for="edit_full_name">Full Name</label>
                            <input type="text" id="edit_full_name" formControlName="full_name" class="form-control"
                                placeholder="Enter full name" />
                            <div class="error-message" *ngIf="f['full_name'].invalid && f['full_name'].touched">
                                <small *ngIf="f['full_name'].errors?.['required']">
                                    Full name is required
                                </small>
                                <small *ngIf="f['full_name'].errors?.['minlength']">
                                    Full name must be at least 3 characters
                                </small>
                            </div>
                        </div>

                        <!-- EMAIL -->
                        <div class="form-group">
                            <label for="edit_email">Email</label>
                            <input type="email" id="edit_email" formControlName="email" class="form-control"
                                placeholder="Enter email" />
                            <div class="error-message" *ngIf="f['email'].invalid && f['email'].touched">
                                <small *ngIf="f['email'].errors?.['required']">
                                    Email is required
                                </small>
                                <small *ngIf="f['email'].errors?.['email']">
                                    Please enter a valid email address
                                </small>
                            </div>
                        </div>

                        <!-- USERNAME (READ ONLY) -->
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" [value]="selectedUser.username" class="form-control" readonly disabled />
                            <small class="form-help">Username cannot be changed</small>
                        </div>

                        <!-- BUTTONS -->
                        <div class="form-actions">
                            <button type="button" (click)="cancelEdit()" class="btn-secondary">
                                Cancel
                            </button>
                            <button type="submit" class="btn-primary" [disabled]="editForm.invalid || isLoading">
                                <span *ngIf="!isLoading">ğŸ’¾ Save Changes</span>
                                <span *ngIf="isLoading">Saving...</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- DANGER ZONE -->
                <div class="danger-zone">
                    <h3>âš ï¸ Danger Zone</h3>
                    <p>Permanently delete this user account. This action cannot be undone.</p>
                    <button (click)="deleteUser(selectedUser)" class="btn-danger"
                        [disabled]="selectedUser.id === currentAdmin?.id">
                        ğŸ—‘ï¸ Delete User
                    </button>
                    <small class="danger-help" *ngIf="selectedUser.id === currentAdmin?.id">
                        You cannot delete your own account
                    </small>
                </div>
            </div>
        </div>

    </main>
</div>